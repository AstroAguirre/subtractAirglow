# subtractAirglow
Subtract H I Lyman-alpha and O I airglow emission from HST-COS G130M spectra and reconstruct the underlying stellar H I and O I emission. This module was developed and optimized for main sequence F, G, K, and M dwarf stars, however the airglow subtraction feature can be used for other targers observed with COS G130M.

## Installation
**It is recommended to install this module in a virtual environment.** The `subtractAirglow` module can be installed by using `pip`:

```
pip install git+https://github.com/AstroAguirre/subtractAirglow.git
```

## Import the GUI
Once installed, the GUI can be accessed by importing the module:
```python
from subtractAirglow import GUI
GUI.run()
```

## Using the GUI
Below is the recommended order of operations when using the airglow subtraction and stellar reconstruction tool.

1. Load a COS G130M spectrum of a supported filetype
   - `*_x1d.fits` files, such as those available from [MAST](https://mast.stsci.edu/portal/Mashup/Clients/Mast/Portal.html)
   - `*.sav.txt` files, produced by [`COADD_X1D.pro`](https://casa.colorado.edu/~danforth/science/cos/coadd_x1d.pro)
2. If prompted, enter additional information. This allows for loading the appropriate model and airglow template
   - Cenwave 1327?: Check this box if the data was taken using Cenwave 1327
   - M Type?: Check this box if the target star is an M dwarf
   - Side A Only?: Check this box if the data was taken only using Side A of the COS detector
3. (Optional) Load a STIS G140M or E140M spectrum, of filetype `*_x1d.fits`
4. Select one of the four airglow contaminated emission lines, and if necessary, press the "Edit Ranges" button to adjust the fitting window
5. Input the initial guesses for the stellar radial velocity and ISM radial velocity. Press Enter in each input box after entering these values
6. Select a Fit Mode
   - One Part: The GUI will simultaneously model stellar emission, self reversal, ISM attenuation, and airglow contamination
   - Two Part: Simultaneously fits all components as in One Part fitting, then performs an internal airglow subtraction and performs a second fit of all non-airglow components on the airglow subtracted spectrum  
7. Select an Airglow Mode
   - Automatic: The airglow template is fit automatically using initial guesses for its spectral location and amplitude
   - Manual: The airglow tempalte is manually placed with user input for its spectral location and amplitude
8. Use the sliders/input boxes surrounding the plot window to adjust the fit as needed (the matplotlib toolbar is available on the top of the GUI window)
9. (Optional) Use the "Normalized Residuals Menu" to remove data points which are negatively driving the best fit
10. (Optional) If STIS data was loaded, press the "Check STIS Comparison" button to compare the two airglow-free spectra
11. Once the fit has been finalized **for the selected emission line**, press "Remove Airglow". This will generate airglow removal plots in separate windows
12. (Optional) Press "Bootstrapping Menu" to generate 1 sigma confidence intervals for the best fit parameters via a residual resampling circular block bootstrap routine (this will replace the 1 sigma parameter errors generated by the standard fitting routine)
13. Select another emission line which requires an airglow subtraction and repeat steps 8 - 12 
14. Once all airglow subtractions have been complete and finalized, press "Save Recovered Spectrum" to save the data to a `.csv` file (an additional `.csv` file containing all user inputs is created automatically, for reproducibility)

**Note: The GUI may appear to freeze while generating a best fit to the data (particularly for H I Lyman-alpha) and when running bootstraps. It is likely that the GUI is running in the background, and will unfreeze once a fit is generated/the bootstrap is completed. Check the python terminal for any errors, as this is a likely indicator that the GUI has actually crashed.**
